pipeline {
    agent any

    environment {
        DOCKER_HUB   = "anas025"                  // Docker Hub username
        IMAGE_NAME   = "for-docker-app"           // Docker Hub repo name
        IMAGE_TAG    = "dev-${BUILD_NUMBER}"      // Version tag (auto from Jenkins)
        FULL_IMAGE   = "${DOCKER_HUB}/${IMAGE_NAME}:${IMAGE_TAG}"
        LATEST_IMAGE = "${DOCKER_HUB}/${IMAGE_NAME}:dev-latest"
        NAMESPACE    = "dev"                      // Kubernetes namespace
    }

    stages {

        stage('Checkout Application Repo') {
            steps {
                dir('app') {   // <-- separate folder for application
                    git branch: 'dev',
                        url: 'https://github.com/flutterdeveloper2025-tech/my-app'
                }
            }
        }

        stage('Checkout Manifests Repo') {
            steps {
                dir('manifests') {  // <-- separate folder for manifests
                    git branch: 'dev',
                        url: 'https://github.com/flutterdeveloper2025-tech/my-app-manifests',
                        changelog: false
                }
            }
        }

        stage('Setup Kubeconfig') {
            steps {
                withCredentials([file(credentialsId: 'kubernetes_config', variable: 'KUBECONFIG_FILE')]) {
                    sh """
                    mkdir -p \$HOME/.kube
                    cp \$KUBECONFIG_FILE \$HOME/.kube/config
                    chmod 600 \$HOME/.kube/config
                    """
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('app') {   // <-- point Docker build context to app folder
                    sh """
                    docker build -t $FULL_IMAGE .
                    docker tag $FULL_IMAGE $LATEST_IMAGE
                    """
                }
            }
        }

        stage('Docker Login & Push') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker_registry_dev',
                    usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    sh """
                    echo \$PASS | docker login -u \$USER --password-stdin
                    docker push $FULL_IMAGE
                    docker push $LATEST_IMAGE
                    """
                }
            }
        }

        stage('Update Deployment YAML') {
    steps {
        dir('manifests') {
            withCredentials([usernamePassword(credentialsId: 'github_creds', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                sh """
                # Update image in dev deployment YAML
                sed -i 's|image:.*|image: $FULL_IMAGE|' dev/dev-deployment.yaml

                # Git config
                git config user.email "jenkins@example.com"
                git config user.name "Jenkins CI"

                # Setup Git credential helper
                git config credential.helper store
                echo "https://\$USER:\$PASS@github.com" > ~/.git-credentials

                # Commit and push changes
                git add dev/dev-deployment.yaml
                git commit -m "Update DEV image tag to $FULL_IMAGE" || echo "No changes to commit"
                git push origin dev
                """
            }
        }
    }
}


        stage('ArgoCD Sync') {
            steps {
                withEnv(["KUBECONFIG=$HOME/.kube/config"]) {
                    sh """
                    argocd app sync myapp-dev || echo "ArgoCD sync failed, check manually"
                    """
                }
            }
        }

        stage('Smoke Test') {
            steps {
                withEnv(["KUBECONFIG=$HOME/.kube/config"]) {
                    sh """
                    EXTERNAL_IP=\$(kubectl get svc mywebsite-service -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
                    STATUS=\$(curl -o /dev/null -s -w "%{http_code}" http://\$EXTERNAL_IP)
                    if [ "\$STATUS" != "200" ]; then
                        echo "‚ùå DEV App not reachable at \$EXTERNAL_IP"
                        exit 1
                    fi
                    echo "‚úÖ DEV App running successfully at \$EXTERNAL_IP"
                    """
                }
            }
        }
    }

    post {
        success { echo "üéâ DEV deployment to Kubernetes successful" }
        failure { echo "‚ùå DEV deployment failed" }
    }
}
