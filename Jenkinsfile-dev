pipeline {
    agent any

    environment {
        BRANCH_NAME  = "dev"  
        DOCKER_HUB   = "anas025"
        IMAGE_NAME   = "for-docker-app"
        IMAGE_TAG    = "${BRANCH_NAME}-${BUILD_NUMBER}"  
        FULL_IMAGE   = "${DOCKER_HUB}/${IMAGE_NAME}:${IMAGE_TAG}"
        LATEST_IMAGE = "${DOCKER_HUB}/${IMAGE_NAME}:${BRANCH_NAME}-latest"
        NAMESPACE    = "${BRANCH_NAME}"  
    }

    stages {

        stage('Checkout Application Repo') {
            steps {
                dir('app') {
                    git branch: "${BRANCH_NAME}",
                        url: 'https://github.com/flutterdeveloper2025-tech/my-app'
                }
            }
        }

        stage('Checkout Manifests Repo') {
            steps {
                dir('manifests') {
                    git branch: "${BRANCH_NAME}",
                        url: 'https://github.com/flutterdeveloper2025-tech/my-app-manifests'
                }
            }
        }

        stage('SonarQube Scan') {
    steps {
        withSonarQubeEnv('MySonarQube') {
            withCredentials([string(credentialsId: 'sonarqube_token', variable: 'SONAR_TOKEN')]) {
                sh """
                /var/lib/jenkins/tools/hudson.plugins.sonar.SonarRunnerInstallation/MySonarScanner/bin/sonar-scanner \
                -Dsonar.projectKey=my-app-dev \
                -Dsonar.sources=. \
                -Dsonar.login=${SONAR_TOKEN}
                """
            }
        }
    }
}

stage('Quality Gate') {
    steps {
        script {
            timeout(time: 1, unit: 'MINUTES') {  // SonarQube analysis complete hone ka time
                def qg = waitForQualityGate()
                
                // Quality Gate fail hone par ab pipeline abort nahi hoga
                echo "SonarQube Quality Gate status: ${qg.status}"
            }
        }
    }
}




        stage('Setup Kubeconfig') {
            steps {
                withCredentials([file(credentialsId: 'kubernetes_config', variable: 'KUBECONFIG_FILE')]) {
                    sh """
                        mkdir -p \$HOME/.kube
                        cp \$KUBECONFIG_FILE \$HOME/.kube/config
                        chmod 600 \$HOME/.kube/config
                    """
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('app') {
                    sh """
                        docker build -t $FULL_IMAGE .
                        docker tag $FULL_IMAGE $LATEST_IMAGE
                    """
                }
            }
        }

        // ‚úÖ New Trivy Scan Stage
        stage('Trivy Image Scan') {
            steps {
                script {
                    sh """
                        trivy image --severity HIGH,CRITICAL -f json -o trivy-report.json $FULL_IMAGE || true
                    """
                    def report = readFile('trivy-report.json')
                    if (report.contains('"Vulnerabilities":[')) {
                        echo "‚ö† Vulnerabilities found in Docker image $FULL_IMAGE"
                    } else {
                        echo "‚úÖ No critical/high vulnerabilities found in $FULL_IMAGE"
                    }
                }
            }
        }

        stage('Docker Login & Push') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker_registry_dev', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    sh """
                        echo \$PASS | docker login -u \$USER --password-stdin
                        docker push $FULL_IMAGE
                        docker push $LATEST_IMAGE
                    """
                }
            }
        }

        stage('Update Deployment YAML & Push') {
            steps {
                dir('manifests') {
                    withCredentials([string(credentialsId: 'github_pat', variable: 'GITHUB_PAT')]) {
                        sh """
                            sed -i 's|image:.*|image: $FULL_IMAGE|' dev/dev-deployment.yaml

                            git config user.email "jenkins@example.com"
                            git config user.name "Jenkins CI"

                            git remote set-url origin https://\$GITHUB_PAT@github.com/flutterdeveloper2025-tech/my-app-manifests.git
                            if ! git diff --quiet dev/dev-deployment.yaml; then
                                git add dev/dev-deployment.yaml
                                git commit -m "[ci skip] Update DEV image to $FULL_IMAGE"
                                git push origin dev
                            else
                                echo "‚úÖ No changes in deployment YAML, skipping push"
                            fi
                        """
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                dir('manifests') {
                    sh """
                        kubectl apply -f dev/dev-deployment.yaml -n $NAMESPACE
                        kubectl apply -f dev/dev-service.yaml -n $NAMESPACE
                        kubectl rollout restart deployment mywebsite -n $NAMESPACE
                    """
                }
            }
        }

        stage('Smoke Test') {
            steps {
                withEnv(["KUBECONFIG=$HOME/.kube/config"]) {
                    sh """
                        EXTERNAL_IP=\$(kubectl get svc mywebsite-service -n $NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
                        STATUS=\$(curl -o /dev/null -s -w "%{http_code}" http://\$EXTERNAL_IP)
                        if [ "\$STATUS" != "200" ]; then
                            echo "‚ùå ${BRANCH_NAME} App not reachable at \$EXTERNAL_IP"
                            exit 1
                        fi
                        echo "‚úÖ ${BRANCH_NAME} App running successfully at \$EXTERNAL_IP"
                    """
                }
            }
        }
    }

    post {
        success { echo "üéâ ${BRANCH_NAME} deployment to Kubernetes successful" }
        failure { echo "‚ùå ${BRANCH_NAME} deployment failed" }
    }
}
